1. High-Level ArchitectureThe system utilizes a Twin-Network Topology where mains-powered ESP32 sensors send encrypted data via MQTT to a local Edge Server (Raspberry Pi 5). The Frontend (Next.js) consumes a REST API provided by this Edge Server.IoT Layer: ESP32 Sensors (Mains powered) $\rightarrow$ Secure MQTT $\rightarrow$ Edge Server.Edge Server: Python (FastAPI) Backend. Ingests MQTT, decrypts data, stores in SQL, and exposes a REST API.Frontend: Next.js Dashboard. Connects to the Edge Server API to visualize data and manage devices.Identity: Auth0. The Frontend manages login; the Backend validates tokens.2. Authentication Strategy (Auth0 + Claiming)The system does not use a local user database. It uses "Token-Based Ownership".Login: User logs into the Frontend via Auth0.Token: Frontend attaches the Auth0 Bearer Token to every API request.Validation: The Backend validates the token signature.Claiming (First Run):The Edge Server starts with No Owner.The first authenticated user to call the API "Claims" the device.The Backend stores this user's Auth0 ID (sub) as the owner.All subsequent requests are checked: Token.sub == Stored_Owner.3. The Edge Server API Contract (Backend: FastAPI)The Frontend will consume the following endpoints (Base URL: http://localhost:8000 or http://antigravity.local:8000).A. System & AuthGET /api/system/statusResponse: {"claimed": boolean, "version": "4.3"}Usage: If claimed: false, redirect user to the /setup wizard.POST /api/setup/claimHeader: Authorization: Bearer <token>Response: {"status": "success", "message": "Device claimed"}Usage: The "Claim Device" button in the setup wizard.B. Device ManagementGET /api/devicesResponse: Array of Device Objects.Schema:JSON[
  {
    "device_id": 1,
    "name": "Fermentation Tank A",
    "profile": "ph_meter",       // "UNKNOWN" if new
    "status": "ONLINE",          // "ONLINE" or "OFFLINE"
    "last_seen": "2023-10-27T10:00:00Z",
    "config_interval": 300
  }
]
Usage: Main Dashboard Grid. Highlight devices with profile: "UNKNOWN".PUT /api/devices/{id} (Update Metadata)Payload: {"name": "New Name", "profile": "new_profile"}Usage: User configures a newly discovered sensor.POST /api/devices/{id}/config (Remote Control)Payload: {"interval": 60}Usage: User changes the sensor's read frequency. This triggers a Backend MQTT publish.C. Sensor DataGET /api/readings/{id}Params: ?limit=100Response:JSON[
  {
    "timestamp": "2023-10-27T10:05:00Z",
    "val_1": 7.2,  // Meaning depends on Profile (e.g., pH)
    "val_2": 24.5, // Meaning depends on Profile (e.g., Temp)
    "battery": 4.1
  }
]
Usage: Detail View Charts.4. Hardware Profiles (For UI Rendering)The Frontend must interpret the generic val_1 and val_2 based on the device's profile string.Profile CodeNameValue 1 LabelValue 2 LabelChart Typeph_meterSmart pH NodepH (0-14)Temp (°C)Line + Linetemp_probeTemp ScoutTemp (°C)nullSingle Lineec_meterNutrient TrackerEC ($\mu S/cm$)Temp (°C)Line + Lineorp_meterRedox ScoutORP (mV)nullSingle Lineindustrial4-20mA AdapterValue (%)nullAreagas_monitorGas SentinelGas (ppm)nullBar/LineUNKNOWNUnprovisionedRaw 1Raw 2Show Setup Prompt5. MQTT Topic Structure (Reference Only)Note: The Frontend does NOT connect to MQTT directly. It uses the API. This is for context on how data moves.Uplink (Sensor -> Server): nodes/{device_id}/dataPayload: Encrypted AES-128 Binary.Downlink (Server -> Sensor): nodes/{device_id}/configPayload: Encrypted Config Struct.6. Frontend Tech Stack RequirementsFramework: Next.js 14+ (App Router).Styling: Tailwind CSS + Shadcn UI.Auth: @auth0/nextjs-auth0.Data Fetching: SWR (Stale-While-Revalidate) for auto-refreshing dashboard data.Charts: Recharts (Responsive containers).7. Development RoadmapAuth Integration: Set up Auth0 Provider and Login/Logout routes.API Client: Create an Axios instance that auto-injects the Bearer Token.Setup Wizard (/setup): Build the "Claim Device" flow.Dashboard (/dashboard): Build the card grid and "Auto-Discovery" alerts for new sensors.Device Detail (/device/[id]): Implement the dynamic charting logic based on the Profile table above.